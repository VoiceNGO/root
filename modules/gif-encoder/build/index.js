'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _class, _temp;

var _canvas = require('canvas');

var _canvas2 = _interopRequireDefault(_canvas);

var _colorTable = require('./color-table');

var _colorTable2 = _interopRequireDefault(_colorTable);

var _lzw = require('./lzw');

var _lzw2 = _interopRequireDefault(_lzw);

var _stream = require('stream');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const DISPOSAL_METHODS = {
  DO_NOT_DISPOSE: 1,
  RESTORE_TO_BACKGROUND: 2,
  RESTORE_TO_PREVIOUS: 3
};

const COLOR_WEIGHT_METHODS = {
  perceptive: (r1, g1, b1, r2, g2, b2) => Math.pow((r2 - r1) * 0.3, 2) + Math.pow((g2 - g1) * 0.59, 2) + Math.pow((b2 - b1) * 0.11, 2),
  actual: (r1, g1, b1, r2, g2, b2) => Math.pow(r2 - r1, 2) + Math.pow(g2 - g1, 2) + Math.pow(b2 - b1, 2)
};

function littleEndian(number, length) {
  const bytes = new Array(length);
  for (let i = 0; i < length; i++) {
    bytes[i] = number >> 8 * (length - 1 - i) & 0xff;
  }
  return bytes;
}

let GIFCanvas = (_temp = _class = class GIFCanvas extends _canvas2.default {

  constructor(width, height) {
    super(width, height);

    this.preserveTransparency = true;
    this.forceLocallColorTable = false;
    this.forceGlobalColorTable = false;
    this.colorTable = null;
    this.currentFrameIndex = -1;
    this.delay = 33;
    this.repeat = true;
    this.colorWeightMethod = COLOR_WEIGHT_METHODS.perceptive;
    this.disposalMethod = DISPOSAL_METHODS.DO_NOT_DISPOSE;
    this.headersWritten = false;
    this.readStream = new _stream.Readable();
    this.lastBGFrame = null;
    this.addFrame();
  }

  flush() {
    if (!this.headersWritten) {
      this.readStream.push(Buffer.from(this.getHeaderBytes()));
      this.headersWritten = true;
    }

    if (this.currentFrame && !this.currentFrame.flushed) {
      this.readStream.push(this.currentFrame.toBuffer(this.lastBGFrame));
      this.currentFrame.setFlushed(true);
    }

    return this;
  }

  getHeaderBytes() {
    const colorTableSize = this.colorTable ? { '256': 7, '128': 6, '64': 5, '32': 4, '16': 3, '8': 2, '4': 1 }[this.colorTable.length] : 0;
    const packedHeaderByte = (this.colorTable ? 1 << 7 : 0) | 7 << 4 | // color resolution
    colorTableSize;

    return [0x47, 0x49, 0x46, 0x38, 0x39, 0x61] // "GIF89a"
    .concat(littleEndian(this.width, 2), littleEndian(this.height, 2), packedHeaderByte, 0, 0);
  }

  setPreserveTransparency(allow) {
    this.preserveTransparency = allow;

    return this;
  }

  setForceLocalColorTable(force) {
    this.forceLocallColorTable = force;

    return this;
  }

  setForceGlobalColorTable(force) {
    this.forceGlobalColorTable = force;

    return this;
  }

  getColorTable() {
    return this.colorTable;
  }

  setColorTable(table) {
    this.colorTable = table;

    return this;
  }

  setDelay(delay) {
    this.delay = delay;

    return this;
  }

  setRepeat(repeat) {
    if (this.headersWritten) {
      throw new Error('setRepeat can not be called after headers have been written');
    }
    this.repeat = repeat;

    return this;
  }

  setColorWeightMethod(fn) {
    this.colorWeightMethod = fn;

    return this;
  }

  addFrame() {
    if (this.currentFrameIndex >= 0) this.flush();

    const { delay, disposalMethod, forceGlobalColorTable, transparentColorIndex } = this;
    const colorTable = forceGlobalColorTable ? this.colorTable : null;

    this.frames.push(new GIFFrame({ delay, disposalMethod, colorTable }));
    this.currentFrameIndex++;

    return this;
  }

  end() {
    this.flush();
    this.readStream.push();
    this.readStream.push(null);
  }
}, _class.DISPOSAL_METHODS = DISPOSAL_METHODS, _class.COLOR_WEIGHT_METHODS = COLOR_WEIGHT_METHODS, _temp);
exports.default = GIFCanvas;
let GIFFrame = class GIFFrame {
  constructor() {
    this.flushed = false;
  }

  toBuffer(previousFrame) {}

  setFlushed(flushed) {
    this.flushed = flushed;
    return this;
  }

  serialize() {
    const graphicsControlExtension = [0x21, 0xf9, byteSize, disposalMethod << 2 | transparentColorFlag, littleEndian(this.delayTime, 2), transparentColorIndex, 0];
    const imageDescriptor = [0x2c, littleEndian(this.left, 2), littleEndian(this.top, 2), littleEndian(this.width, 2), littleEndian(this.height, 2), localColorFlag << 7 | interlaceFlag << 6 | sortFlag << 5 | colorTableSize];
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJESVNQT1NBTF9NRVRIT0RTIiwiRE9fTk9UX0RJU1BPU0UiLCJSRVNUT1JFX1RPX0JBQ0tHUk9VTkQiLCJSRVNUT1JFX1RPX1BSRVZJT1VTIiwiQ09MT1JfV0VJR0hUX01FVEhPRFMiLCJwZXJjZXB0aXZlIiwicjEiLCJnMSIsImIxIiwicjIiLCJnMiIsImIyIiwiTWF0aCIsInBvdyIsImFjdHVhbCIsImxpdHRsZUVuZGlhbiIsIm51bWJlciIsImxlbmd0aCIsImJ5dGVzIiwiQXJyYXkiLCJpIiwiR0lGQ2FudmFzIiwiQ2FudmFzIiwiY29uc3RydWN0b3IiLCJ3aWR0aCIsImhlaWdodCIsInByZXNlcnZlVHJhbnNwYXJlbmN5IiwiZm9yY2VMb2NhbGxDb2xvclRhYmxlIiwiZm9yY2VHbG9iYWxDb2xvclRhYmxlIiwiY29sb3JUYWJsZSIsImN1cnJlbnRGcmFtZUluZGV4IiwiZGVsYXkiLCJyZXBlYXQiLCJjb2xvcldlaWdodE1ldGhvZCIsImRpc3Bvc2FsTWV0aG9kIiwiaGVhZGVyc1dyaXR0ZW4iLCJyZWFkU3RyZWFtIiwiUmVhZGFibGUiLCJsYXN0QkdGcmFtZSIsImFkZEZyYW1lIiwiZmx1c2giLCJwdXNoIiwiQnVmZmVyIiwiZnJvbSIsImdldEhlYWRlckJ5dGVzIiwiY3VycmVudEZyYW1lIiwiZmx1c2hlZCIsInRvQnVmZmVyIiwic2V0Rmx1c2hlZCIsImNvbG9yVGFibGVTaXplIiwicGFja2VkSGVhZGVyQnl0ZSIsImNvbmNhdCIsInNldFByZXNlcnZlVHJhbnNwYXJlbmN5IiwiYWxsb3ciLCJzZXRGb3JjZUxvY2FsQ29sb3JUYWJsZSIsImZvcmNlIiwic2V0Rm9yY2VHbG9iYWxDb2xvclRhYmxlIiwiZ2V0Q29sb3JUYWJsZSIsInNldENvbG9yVGFibGUiLCJ0YWJsZSIsInNldERlbGF5Iiwic2V0UmVwZWF0IiwiRXJyb3IiLCJzZXRDb2xvcldlaWdodE1ldGhvZCIsImZuIiwidHJhbnNwYXJlbnRDb2xvckluZGV4IiwiZnJhbWVzIiwiR0lGRnJhbWUiLCJlbmQiLCJwcmV2aW91c0ZyYW1lIiwic2VyaWFsaXplIiwiZ3JhcGhpY3NDb250cm9sRXh0ZW5zaW9uIiwiYnl0ZVNpemUiLCJ0cmFuc3BhcmVudENvbG9yRmxhZyIsImRlbGF5VGltZSIsImltYWdlRGVzY3JpcHRvciIsImxlZnQiLCJ0b3AiLCJsb2NhbENvbG9yRmxhZyIsImludGVybGFjZUZsYWciLCJzb3J0RmxhZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBRUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFPQSxNQUFNQSxtQkFBbUI7QUFDdkJDLGtCQUFnQixDQURPO0FBRXZCQyx5QkFBdUIsQ0FGQTtBQUd2QkMsdUJBQXFCO0FBSEUsQ0FBekI7O0FBTUEsTUFBTUMsdUJBQTREO0FBQ2hFQyxjQUFZLENBQUNDLEVBQUQsRUFBS0MsRUFBTCxFQUFTQyxFQUFULEVBQWFDLEVBQWIsRUFBaUJDLEVBQWpCLEVBQXFCQyxFQUFyQixLQUNWQyxLQUFLQyxHQUFMLENBQVMsQ0FBQ0osS0FBS0gsRUFBTixJQUFZLEdBQXJCLEVBQTBCLENBQTFCLElBQStCTSxLQUFLQyxHQUFMLENBQVMsQ0FBQ0gsS0FBS0gsRUFBTixJQUFZLElBQXJCLEVBQTJCLENBQTNCLENBQS9CLEdBQStESyxLQUFLQyxHQUFMLENBQVMsQ0FBQ0YsS0FBS0gsRUFBTixJQUFZLElBQXJCLEVBQTJCLENBQTNCLENBRkQ7QUFHaEVNLFVBQVEsQ0FBQ1IsRUFBRCxFQUFLQyxFQUFMLEVBQVNDLEVBQVQsRUFBYUMsRUFBYixFQUFpQkMsRUFBakIsRUFBcUJDLEVBQXJCLEtBQTRCQyxLQUFLQyxHQUFMLENBQVNKLEtBQUtILEVBQWQsRUFBa0IsQ0FBbEIsSUFBdUJNLEtBQUtDLEdBQUwsQ0FBU0gsS0FBS0gsRUFBZCxFQUFrQixDQUFsQixDQUF2QixHQUE4Q0ssS0FBS0MsR0FBTCxDQUFTRixLQUFLSCxFQUFkLEVBQWtCLENBQWxCO0FBSGxCLENBQWxFOztBQU1BLFNBQVNP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QUs1QixLQUFMO0FBQ0EsU0FBS0osVUFBTCxDQUFnQkssSUFBaEI7QUFDQSxTQUFLTCxVQUFMLENBQWdCSyxJQUFoQixDQUFxQixJQUFyQjtBQUNEO0FBcEgyQyxDLFNBQ3JDekMsZ0IsR0FBbUJBLGdCLFNBQ25CSSxvQixHQUF1QkEsb0I7a0JBRlhpQixTO0lBdUhmOEMsUSxHQUFOLE1BQU1BLFFBQU4sQ0FBZTtBQUFBO0FBQUEsU0FDYnJCLE9BRGEsR0FDTSxLQUROO0FBQUE7O0FBRWJDLFdBQVNzQixhQUFULEVBQTJDLENBQUU7O0FBRTdDckIsYUFBV0YsT0FBWCxFQUFtQztBQUNqQyxTQUFLQSxPQUFMLEdBQWVBLE9BQWY7QUFDQSxXQUFPLElBQVA7QUFDRDs7QUFFRHdCLGNBQTJCO0FBQ3pCLFVBQU1DLDJCQUEyQixDQUMvQixJQUQrQixFQUUvQixJQUYrQixFQUcvQkMsUUFIK0IsRUFJOUJ0QyxrQkFBa0IsQ0FBbkIsR0FBd0J1QyxvQkFKTyxFQUsvQjFELGFBQWEsS0FBSzJELFNBQWxCLEVBQTZCLENBQTdCLENBTCtCLEVBTS9CVCxxQkFOK0IsRUFPL0IsQ0FQK0IsQ0FBakM7QUFTQSxVQUFNVSxrQkFBa0IsQ0FDdEIsSUFEc0IsRUFFdEI1RCxhQUFhLEtBQUs2RCxJQUFsQixFQUF3QixDQUF4QixDQUZzQixFQUd0QjdELGFBQWEsS0FBSzhELEdBQWxCLEVBQXVCLENBQXZCLENBSHNCLEVBSXRCOUQsYUFBYSxLQUFLUyxLQUFsQixFQUF5QixDQUF6QixDQUpzQixFQUt0QlQsYUFBYSxLQUFLVSxNQUFsQixFQUEwQixDQUExQixDQUxzQixFQU1yQnFELGtCQUFrQixDQUFuQixHQUF5QkMsaUJBQWlCLENBQTFDLEdBQWdEQyxZQUFZLENBQTVELEdBQWlFL0IsY0FOM0MsQ0FBeEI7QUFRRDtBQTNCWSxDIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcblxuaW1wb3J0IENhbnZhcyBmcm9tICdjYW52YXMnO1xuaW1wb3J0IENvbG9yVGFibGUgZnJvbSAnLi9jb2xvci10YWJsZSc7XG5pbXBvcnQgTFpXIGZyb20gJy4vbHp3JztcbmltcG9ydCB7IFJlYWRhYmxlIH0gZnJvbSAnc3RyZWFtJztcblxuZXhwb3J0IHR5cGUgdENvbG9yID0gW051bWJlciwgTnVtYmVyLCBOdW1iZXJdO1xuZXhwb3J0IHR5cGUgdENvbG9yVGFibGUgPSBBcnJheTx0Q29sb3I+O1xuZXhwb3J0IHR5cGUgdERpc3Bvc2FsTWV0aG9kcyA9ICRWYWx1ZXM8dHlwZW9mIERJU1BPU0FMX01FVEhPRFM+O1xuZXhwb3J0IHR5cGUgdENvbG9yV2VpZ2h0U2lnbmF0dXJlID0gKHIxOiBudW1iZXIsIGcxOiBudW1iZXIsIGIxOiBudW1iZXIsIHIyOiBudW1iZXIsIGcyOiBudW1iZXIsIGIyOiBudW1iZXIpID0+IG51bWJlcjtcblxuY29uc3QgRElTUE9TQUxfTUVUSE9EUyA9IHtcbiAgRE9fTk9UX0RJU1BPU0U6IDEsXG4gIFJFU1RPUkVfVE9fQkFDS0dST1VORDogMixcbiAgUkVTVE9SRV9UT19QUkVWSU9VUzogMyxcbn07XG5cbmNvbnN0IENPTE9SX1dFSUdIVF9NRVRIT0RTOiB7IFtzdHJpbmddOiB0Q29sb3JXZWlnaHRTaWduYXR1cmUgfSA9IHtcbiAgcGVyY2VwdGl2ZTogKHIxLCBnMSwgYjEsIHIyLCBnMiwgYjIpID0+XG4gICAgTWF0aC5wb3coKHIyIC0gcjEpICogMC4zLCAyKSArIE1hdGgucG93KChnMiAtIGcxKSAqIDAuNTksIDIpICsgTWF0aC5wb3coKGIyIC0gYjEpICogMC4xMSwgMiksXG4gIGFjdHVhbDogKHIxLCBnMSwgYjEsIHIyLCBnMiwgYjIpID0+IE1hdGgucG93KHIyIC0gcjEsIDIpICsgTWF0aC5wb3coZzIgLSBnMSwgMikgKyBNYXRoLnBvdyhiMiAtIGIxLCAyKSxcbn07XG5cbmZ1bmN0aW9uIGxpdHRsZUVuZGlhbihudW1iZXI6IG51bWJlciwgbGVuZ3RoOiBudW1iZXIpOiBBcnJheTxudW1iZXI+IHtcbiAgY29uc3QgYnl0ZXMgPSBuZXcgQXJyYXkobGVuZ3RoKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgIGJ5dGVzW2ldID0gKG51bWJlciA+PiAoOCAqIChsZW5ndGggLSAxIC0gaSkpKSAmIDB4ZmY7XG4gIH1cbiAgcmV0dXJuIGJ5dGVzO1xufVxuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBHSUZDYW52YXMgZXh0ZW5kcyBDYW52YXMge1xuICBzdGF0aWMgRElTUE9TQUxfTUVUSE9EUyA9IERJU1BPU0FMX01FVEhPRFM7XG4gIHN0YXRpYyBDT0xPUl9XRUlHSFRfTUVUSE9EUyA9IENPTE9SX1dFSUdIVF9NRVRIT0RTO1xuXG4gIHByZXNlcnZlVHJhbnNwYXJlbmN5OiBib29sZWFuID0gdHJ1ZTtcbiAgZm9yY2VMb2NhbGxDb2xvclRhYmxlOiBib29sZWFuID0gZmFsc2U7XG4gIGZvcmNlR2xvYmFsQ29sb3JUYWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuICBjb2xvclRhYmxlOiA/dENvbG9yVGFibGUgPSBudWxsO1xuICBjdXJyZW50RnJhbWU6IEdJRkZyYW1lO1xuICBjdXJyZW50RnJhbWVJbmRleDogbnVtYmVyID0gLTE7XG4gIGRlbGF5OiBudW1iZXIgPSAzMztcbiAgcmVwZWF0OiBib29sZWFuID0gdHJ1ZTtcbiAgY29sb3JXZWlnaHRNZXRob2Q6IHRDb2xvcldlaWdodFNpZ25hdHVyZSA9IENPTE9SX1dFSUdIVF9NRVRIT0RTLnBlcmNlcHRpdmU7XG4gIGRpc3Bvc2FsTWV0aG9kOiB0RGlzcG9zYWxNZXRob2RzID0gRElTUE9TQUxfTUVUSE9EUy5ET19OT1RfRElTUE9TRTtcbiAgaGVhZGVyc1dyaXR0ZW46IGJvb2xlYW4gPSBmYWxzZTtcbiAgcmVhZFN0cmVhbTogUmVhZGFibGUgPSBuZXcgUmVhZGFibGUoKTtcbiAgbGFzdEJHRnJhbWU6ID9HSUZGcmFtZSA9IG51bGw7XG5cbiAgY29uc3RydWN0b3Iod2lkdGg6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcbiAgICBzdXBlcih3aWR0aCwgaGVpZ2h0KTtcblxuICAgIHRoaXMuYWRkRnJhbWUoKTtcbiAgfVxuXG4gIGZsdXNoKCk6IHRoaXMge1xuICAgIGlmICghdGhpcy5oZWFkZXJzV3JpdHRlbikge1xuICAgICAgdGhpcy5yZWFkU3RyZWFtLnB1c2goQnVmZmVyLmZyb20odGhpcy5nZXRIZWFkZXJCeXRlcygpKSk7XG4gICAgICB0aGlzLmhlYWRlcnNXcml0dGVuID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jdXJyZW50RnJhbWUgJiYgIXRoaXMuY3VycmVudEZyYW1lLmZsdXNoZWQpIHtcbiAgICAgIHRoaXMucmVhZFN0cmVhbS5wdXNoKHRoaXMuY3VycmVudEZyYW1lLnRvQnVmZmVyKHRoaXMubGFzdEJHRnJhbWUpKTtcbiAgICAgIHRoaXMuY3VycmVudEZyYW1lLnNldEZsdXNoZWQodHJ1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBnZXRIZWFkZXJCeXRlcygpOiBBcnJheTxudW1iZXI+IHtcbiAgICBjb25zdCBjb2xvclRhYmxlU2l6ZSA9IHRoaXMuY29sb3JUYWJsZVxuICAgICAgPyB7ICcyNTYnOiA3LCAnMTI4JzogNiwgJzY0JzogNSwgJzMyJzogNCwgJzE2JzogMywgJzgnOiAyLCAnNCc6IDEgfVt0aGlzLmNvbG9yVGFibGUubGVuZ3RoXVxuICAgICAgOiAwO1xuICAgIGNvbnN0IHBhY2tlZEhlYWRlckJ5dGUgPVxuICAgICAgKHRoaXMuY29sb3JUYWJsZSA/IDEgPDwgNyA6IDApIHxcbiAgICAgICg3IDw8IDQpIHwgLy8gY29sb3IgcmVzb2x1dGlvblxuICAgICAgY29sb3JUYWJsZVNpemU7XG5cbiAgICByZXR1cm4gWzB4NDcsIDB4NDksIDB4NDYsIDB4MzgsIDB4MzksIDB4NjFdIC8vIFwiR0lGODlhXCJcbiAgICAgIC5jb25jYXQobGl0dGxlRW5kaWFuKHRoaXMud2lkdGgsIDIpLCBsaXR0bGVFbmRpYW4odGhpcy5oZWlnaHQsIDIpLCBwYWNrZWRIZWFkZXJCeXRlLCAwLCAwKTtcbiAgfVxuXG4gIHNldFByZXNlcnZlVHJhbnNwYXJlbmN5KGFsbG93OiBib29sZWFuKTogdGhpcyB7XG4gICAgdGhpcy5wcmVzZXJ2ZVRyYW5zcGFyZW5jeSA9IGFsbG93O1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRGb3JjZUxvY2FsQ29sb3JUYWJsZShmb3JjZTogYm9vbGVhbik6IHRoaXMge1xuICAgIHRoaXMuZm9yY2VMb2NhbGxDb2xvclRhYmxlID0gZm9yY2U7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNldEZvcmNlR2xvYmFsQ29sb3JUYWJsZShmb3JjZTogYm9vbGVhbik6IHRoaXMge1xuICAgIHRoaXMuZm9yY2VHbG9iYWxDb2xvclRhYmxlID0gZm9yY2U7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGdldENvbG9yVGFibGUoKTogP3RDb2xvclRhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5jb2xvclRhYmxlO1xuICB9XG5cbiAgc2V0Q29sb3JUYWJsZSh0YWJsZTogdENvbG9yVGFibGUpOiB0aGlzIHtcbiAgICB0aGlzLmNvbG9yVGFibGUgPSB0YWJsZTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0RGVsYXkoZGVsYXk6IG51bWJlcik6IHRoaXMge1xuICAgIHRoaXMuZGVsYXkgPSBkZWxheTtcblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgc2V0UmVwZWF0KHJlcGVhdDogYm9vbGVhbik6IHRoaXMge1xuICAgIGlmICh0aGlzLmhlYWRlcnNXcml0dGVuKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NldFJlcGVhdCBjYW4gbm90IGJlIGNhbGxlZCBhZnRlciBoZWFkZXJzIGhhdmUgYmVlbiB3cml0dGVuJyk7XG4gICAgfVxuICAgIHRoaXMucmVwZWF0ID0gcmVwZWF0O1xuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBzZXRDb2xvcldlaWdodE1ldGhvZChmbjogRnVuY3Rpb24pOiB0aGlzIHtcbiAgICB0aGlzLmNvbG9yV2VpZ2h0TWV0aG9kID0gZm47XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGFkZEZyYW1lKCk6IHRoaXMge1xuICAgIGlmICh0aGlzLmN1cnJlbnRGcmFtZUluZGV4ID49IDApIHRoaXMuZmx1c2goKTtcblxuICAgIGNvbnN0IHsgZGVsYXksIGRpc3Bvc2FsTWV0aG9kLCBmb3JjZUdsb2JhbENvbG9yVGFibGUsIHRyYW5zcGFyZW50Q29sb3JJbmRleCB9ID0gdGhpcztcbiAgICBjb25zdCBjb2xvclRhYmxlID0gZm9yY2VHbG9iYWxDb2xvclRhYmxlID8gdGhpcy5jb2xvclRhYmxlIDogbnVsbDtcblxuICAgIHRoaXMuZnJhbWVzLnB1c2gobmV3IEdJRkZyYW1lKHsgZGVsYXksIGRpc3Bvc2FsTWV0aG9kLCBjb2xvclRhYmxlIH0pKTtcbiAgICB0aGlzLmN1cnJlbnRGcmFtZUluZGV4Kys7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIGVuZCgpIHtcbiAgICB0aGlzLmZsdXNoKCk7XG4gICAgdGhpcy5yZWFkU3RyZWFtLnB1c2goKTtcbiAgICB0aGlzLnJlYWRTdHJlYW0ucHVzaChudWxsKTtcbiAgfVxufVxuXG5jbGFzcyBHSUZGcmFtZSB7XG4gIGZsdXNoZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgdG9CdWZmZXIocHJldmlvdXNGcmFtZTogP0dpZkZyYW1lKTogQnVmZmVyIHt9XG5cbiAgc2V0Rmx1c2hlZChmbHVzaGVkOiBib29sZWFuKTogdGhpcyB7XG4gICAgdGhpcy5mbHVzaGVkID0gZmx1c2hlZDtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHNlcmlhbGl6ZSgpOiBBcnJheTxudW1iZXI+IHtcbiAgICBjb25zdCBncmFwaGljc0NvbnRyb2xFeHRlbnNpb24gPSBbXG4gICAgICAweDIxLFxuICAgICAgMHhmOSxcbiAgICAgIGJ5dGVTaXplLFxuICAgICAgKGRpc3Bvc2FsTWV0aG9kIDw8IDIpIHwgdHJhbnNwYXJlbnRDb2xvckZsYWcsXG4gICAgICBsaXR0bGVFbmRpYW4odGhpcy5kZWxheVRpbWUsIDIpLFxuICAgICAgdHJhbnNwYXJlbnRDb2xvckluZGV4LFxuICAgICAgMCxcbiAgICBdO1xuICAgIGNvbnN0IGltYWdlRGVzY3JpcHRvciA9IFtcbiAgICAgIDB4MmMsXG4gICAgICBsaXR0bGVFbmRpYW4odGhpcy5sZWZ0LCAyKSxcbiAgICAgIGxpdHRsZUVuZGlhbih0aGlzLnRvcCwgMiksXG4gICAgICBsaXR0bGVFbmRpYW4odGhpcy53aWR0aCwgMiksXG4gICAgICBsaXR0bGVFbmRpYW4odGhpcy5oZWlnaHQsIDIpLFxuICAgICAgKGxvY2FsQ29sb3JGbGFnIDw8IDcpIHwgKGludGVybGFjZUZsYWcgPDwgNikgfCAoc29ydEZsYWcgPDwgNSkgfCBjb2xvclRhYmxlU2l6ZSxcbiAgICBdO1xuICB9XG59XG4iXX0=